---
import '../styles/global.css';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import CursorGlow from '../components/CursorGlow';
import { getLocalizedPath } from '../utils/i18n';

interface Props {
  title?: string;
  description?: string;
  lang?: 'fr' | 'en';
  ogImage?: string;
  ogType?: string;
}

const {
  title = 'Portfolio - Esdras GBEDOZIN',
  description = 'Portfolio Professionnel - Ingénieur Full-Stack & Architecte Cloud',
  lang = 'fr',
  ogImage,
  ogType = 'website',
} = Astro.props;

// SEO: hreflang alternate URLs (FE-094)
const currentPath = Astro.url.pathname.replace(`/${lang}`, ''); // Remove locale from path
const frUrl = new URL(getLocalizedPath(currentPath, 'fr'), Astro.site);
const enUrl = new URL(getLocalizedPath(currentPath, 'en'), Astro.site);

// SEO: Open Graph (FE-105)
const siteUrl = Astro.site?.toString().replace(/\/$/, '') || 'https://esdrasgbedozin.dev';
const pageUrl = new URL(Astro.url.pathname, siteUrl).toString();
const ogImageUrl = ogImage
  ? new URL(ogImage, siteUrl).toString()
  : new URL('/og-default.png', siteUrl).toString();

// SEO: JSON-LD Structured Data (FE-107)
const personJsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Person',
  name: 'Esdras GBEDOZIN',
  jobTitle:
    lang === 'fr'
      ? 'Ingénieur Full-Stack & Architecte Cloud'
      : 'Full-Stack Engineer & Cloud Architect',
  url: siteUrl,
  sameAs: [
    'https://github.com/esdrasgbedozin',
    'https://linkedin.com/in/esdras-gbedozin-24b3a3271',
  ],
  knowsAbout: ['TypeScript', 'React', 'Astro', 'Azure', 'Node.js', 'Python'],
};

const websiteJsonLd = {
  '@context': 'https://schema.org',
  '@type': 'WebSite',
  name: 'Portfolio - Esdras GBEDOZIN',
  url: siteUrl,
  inLanguage: [lang],
  author: { '@type': 'Person', name: 'Esdras GBEDOZIN' },
};
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- Open Graph Meta Tags (FE-105) -->
    <meta property="og:type" content={ogType} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={pageUrl} />
    <meta property="og:image" content={ogImageUrl} />
    <meta property="og:locale" content={lang === 'fr' ? 'fr_FR' : 'en_US'} />
    <meta property="og:site_name" content="Portfolio - Esdras GBEDOZIN" />

    <!-- Twitter Card Meta Tags (FE-105) -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImageUrl} />

    <!-- Preload critical fonts (FE-102/103) -->
    <link
      rel="preload"
      href="/fonts/inter-latin-var.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href="/fonts/jetbrains-mono-latin-var.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />

    <!-- SEO: hreflang alternate links (FE-094) -->
    <link rel="alternate" hreflang="fr" href={frUrl.toString()} />
    <link rel="alternate" hreflang="en" href={enUrl.toString()} />
    <link rel="alternate" hreflang="x-default" href={frUrl.toString()} />

    <!-- Canonical URL -->
    <link rel="canonical" href={Astro.url.toString()} />

    <!-- JSON-LD Structured Data (FE-107) -->
    <script type="application/ld+json" set:html={JSON.stringify(personJsonLd)} />
    <script type="application/ld+json" set:html={JSON.stringify(websiteJsonLd)} />

    <!-- Analytics: Plausible (privacy-friendly, no cookies) -->
    {
      import.meta.env.PUBLIC_PLAUSIBLE_DOMAIN && (
        <script
          defer
          data-domain={import.meta.env.PUBLIC_PLAUSIBLE_DOMAIN}
          src="https://plausible.io/js/script.js"
        />
      )
    }

    <!-- Named slot for page-specific head elements -->
    <slot name="head" />

    <title>{title}</title>

    <!-- Prevent FOUC: restore theme from localStorage before paint -->
    <script is:inline>
      (function () {
        let theme = localStorage.getItem('theme');
        if (!theme) {
          theme = window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
        }
        const root = document.documentElement;
        root.classList.add(theme);
        root.setAttribute('data-theme', theme);
      })();
    </script>
  </head>
  <body class="bg-[var(--color-neutral-950)] text-[var(--color-neutral-100)]">
    {/* Cursor Glow Effect (desktop only) */}
    <CursorGlow client:idle />

    {/* Scroll Progress Indicator */}
    <div class="scroll-progress" aria-hidden="true"></div>

    <!-- Skip to content link (WCAG 2.4.1) -->
    <a
      href="#main-content"
      class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:px-4 focus:py-2 focus:bg-[var(--color-primary-600)] focus:text-white focus:rounded-lg"
    >
      Skip to content
    </a>

    <!-- Header -->
    <Header lang={lang} />

    <!-- Main Content -->
    <main id="main-content" class="min-h-screen">
      <slot />
    </main>

    <!-- Footer -->
    <Footer lang={lang} />

    <!-- Scroll Progress Script -->
    <script is:inline>
      (function () {
        const el = document.querySelector('.scroll-progress');
        if (!el) {
          return;
        }
        function update() {
          const scrollTop = window.scrollY;
          const docHeight = document.documentElement.scrollHeight - window.innerHeight;
          const progress = docHeight > 0 ? scrollTop / docHeight : 0;
          el.style.setProperty('--scroll-progress', String(progress));
        }
        window.addEventListener('scroll', update, { passive: true });
        update();
      })();
    </script>
  </body>
</html>
